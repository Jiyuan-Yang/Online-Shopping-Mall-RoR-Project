#数据库课程设计系统实现总结报告

## 实现环境

本系统基于web开发框架Ruby on Rails编写，其中Ruby的版本为2.5.1，Rails的版本为5.2.3。

## 系统功能结构图

## 基本表的定义与完整性约束

- User

  | 属性                  | 类型    | 完整性约束                                                   |
  | --------------------- | ------- | ------------------------------------------------------------ |
  | id                    | integer | 主码，索引                                                   |
  | name                  | varchar | not null                                                     |
  | email                 | varchar | not null，且需满足正则表达式                                 |
  | character             | varchar | ('buyer', 'seller', 'administrator')                         |
  | create_at             | date    | （注：由Rails框架自动生成）                                  |
  | update_at             | date    | （注：由Rails框架自动生成）                                  |
  | password_digest       | varchar | （注：由加密模块自动生成，用户不具有对此项的直接修改和删除权限） |
  | receiver_name         | varcher | not null                                                     |
  | receiver_address      | varcher | not null                                                     |
  | receiver_phone_number | varcher | not null                                                     |

- Shop

  | 属性        | 类型    | 完整性约束                  |
  | ----------- | ------- | --------------------------- |
  | id          | integer | 主码，索引                  |
  | name        | varchar | 商店名                      |
  | description | varchar | not null                    |
  | user_id     | integer | 商店对应的用户id            |
  | create_at   | date    | （注：由Rails框架自动生成） |
  | update_at   | date    | （注：由Rails框架自动生成） |

- Product

  | 属性        | 类型    | 完整性约束                                                   |
  | ----------- | ------- | ------------------------------------------------------------ |
  | id          | integer | 主码，索引                                                   |
  | name        | varchar | not null                                                     |
  | description | varchar | not null                                                     |
  | price       | float   | price > 0                                                    |
  | shop_id     | integer | 外部码，reference Shop                                       |
  | category    | varchar | 取值域为('clothes','books', 'office', 'digital','entertainment', 'fruits_and_animals', 'virtual_items') |
  | create_at   | date    | （注：由Rails框架自动生成）                                  |
  | update_at   | date    | （注：由Rails框架自动生成）                                  |

- Order

  | 属性                  | 类型    | 完整性约束                                                   |
  | --------------------- | ------- | ------------------------------------------------------------ |
  | id                    | integer | 主码，索引                                                   |
  | receiver_name         | varcher | not null                                                     |
  | receiver_address      | varcher | not null                                                     |
  | receiver_phone_number | varcher | not null，且需要满足正则表达式                               |
  | status                | integer | 取值域为$\{i|0\leq i\leq4, i\in \N\}$，其取值分别对应状态：发货、装车、派件、等待确认收货、完成 |
  | order_time            | date    |                                                              |
  | total_price           | float   | total_price > 0                                              |
  | create_at             | date    | （注：由Rails框架自动生成）                                  |
  | update_at             | date    | （注：由Rails框架自动生成）                                  |
  | user_id               | integer | 外部码，reference User                                       |
  | link_order_id         | integer | 外部码，reference Order                                      |

- ShoppingCart

  | 属性      | 类型    | 完整性约束                  |
  | --------- | ------- | --------------------------- |
  | id        | integer | 主码，索引                  |
  | user_id   | integer | 外部码，reference User      |
  | create_at | date    | （注：由Rails框架自动生成） |
  | update_at | date    | （注：由Rails框架自动生成） |

- Favorite

  | 属性      | 类型    | 完整性约束                  |
  | --------- | ------- | --------------------------- |
  | id        | integer | 主码，索引                  |
  | user_id   | integer | 外部码，reference User      |
  | create_at | date    | （注：由Rails框架自动生成） |
  | update_at | date    | （注：由Rails框架自动生成） |

- OrderItem

  | 属性             | 类型    | 完整性约束                             |
  | ---------------- | ------- | -------------------------------------- |
  | id               | integer | 主码，索引                             |
  | product_id       | integer | 外部码，reference Product              |
  | amount           | integer | $amount\geq 0$                         |
  | order_id         | integer | 外部码，reference Order                |
  | corresponding_id | integer | 外部码，reference OrderItem            |
  | progress         | integer | 取值域为$\{i|0\leq i\leq 4, i\in \N\}$ |
  | total_price      | float   | total_price > 0                        |
  | create_at        | date    | （注：由Rails框架自动生成）            |
  | update_at        | date    | （注：由Rails框架自动生成）            |

- ShoppingCartItem

  | 属性             | 类型    | 完整性约束                     |
  | ---------------- | ------- | ------------------------------ |
  | id               | integer | 主码，索引                     |
  | product_id       | integer | 外部码，reference Product      |
  | amount           | float   | $amount\geq 0$                 |
  | shopping_cart_id | integer | 外部码，reference ShoppingCart |
  | create_at        | date    | （注：由Rails框架自动生成）    |
  | update_at        | date    | （注：由Rails框架自动生成）    |

- FavoriteItem

  | 属性        | 类型    | 完整性约束                  |
  | ----------- | ------- | --------------------------- |
  | id          | integer | 主码，索引                  |
  | product_id  | integer | 外部码，reference Product   |
  | favorite_id | integer | 外部码，reference Favorite  |
  | create_at   | date    | （注：由Rails框架自动生成） |
  | update_at   | date    | （注：由Rails框架自动生成） |

## 安全性设计

- 在我们设计的系统中，对于安全性的控制，主要是通过用户登录以及对用户进行分级控制，在我们的系统中，用户分为消费者、生产者以及管理员三类。而实现控制安全性，我们主要依靠的是框架的支持，我们认为数据库无法被任何用户通过直接登陆进行访问，即我们确保任何用户所有对于数据库的操作均需要通过前端的操作进行。基于此，我们设计了一套借助Rails框架实现的安全控制机制。

- 首先，我们定义一个公共的视图，未登录或者登陆且角色为消费者、生产者以及管理员的用户均可以访问。具体而言，是指所有商品的信息、店铺的信息以及如主页、关于我们等基本的静态页面。
- 其次，我们进行登陆控制，如果没有登陆，则只能够具有查看以上页面的权限。登陆后，按照权限进行访问。相比较于未登陆的用户，登陆的用户具有对自己的个人信息的查询以及修改权限，同时除管理员用户外，限制其对于其他用户的个人信息的访问以及修改。
- 然后，对于登陆后的用户的权限控制。对于消费者身份的用户，其还有对应的购物车、收藏夹以及订单列表，同时具有对自己的购物车、收藏夹以及订单列表项的插入、删除、修改、查询权限，同时除管理员用户外，限制其对于其他用户的任何信息的删除、修改以及插入。对于经销商身份的用户，其还有对应的店铺，每一个店铺具有对应的商品，同时也具有订单列表，并拥有对其中的表进行插入、删除、修改、查询的权限，同时限制其对于其他用户的任何信息的删除、修改以及插入。对于管理员用户，其具有最高的权限，拥有对于系统中的任何内容进行插入、删除、修改、查询的权限。

## 存储过程、触发器和函数的代码说明

## 主要技术

- Ruby on Rails。我们所使用的框架。体现了典型的MVC设计模式。其中，每一个model对应数据库中的一个基本表，对应的controller为当浏览器发出一条请求时，经过路由，对应触发控制器中的函数，每一个controller对应零至多个view，即具体进行呈现的视图。此框架的一个优点在于，对于数据库的操作并不直接进行，而是通过Ruby的代码对应生成SQL语句，同时对于数据库中基本表的完整性约束也并不是直接使用SQL语句进行添加，而是通过db目录下的migration文件编写，然后执行`rails db:migration`对数据库的完整性约束进行修改。这一特性使得此框架与底层的数据库高度解藕，因此在底层可以对使用的数据库进行较为自由的更换，更换后只要简单修改配置文件即可使用。因此，Rails框架默认使用的是Sqlite，而向Heroku部署时切换为PostgreSQL也比较方便。
- SQL。数据库的结构化查询语言。在我们的系统中的一些部分使用的SQL语句对数据库进行查询。

## 运行实例展示

- 为了方便查看我们的系统，我们将其部署到了Heroku上，这是一个Rails项目的托管平台，由于免费版的条件限制，服务器在网站30分钟内没有访问后进入休眠状态，因此第一次访问时加载时间比较长，此后即恢复正常。
- 网站的地址为：https://the-max-jims.herokuapp.com/
- 

## 源程序说明

## 收货与体会

